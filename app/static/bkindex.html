<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reference Checker</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <!-- Google Fonts (Inter is already loaded) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <!-- React and ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX support -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* Global font */
    body {
      font-family: 'Inter', sans-serif;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    .popover-loading-spinner {
      width: 1rem;
      height: 1rem;
      border-width: 2px;
      border-color: #3b82f6;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Updated infoBox styling: using Inter instead of monospace */
    #infoBox {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      overflow-y: auto;
      white-space: pre-line;
      font-family: 'Inter', sans-serif;
      font-size: 0.95em;
      line-height: 1.5;
      max-height: 15em;
    }
    /* Modal overlay for summary */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-content {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
      max-width: 400px;
      max-height: 200px;
      overflow-y: auto;
      position: relative;
    }
    .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.2rem;
      color: #555;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Gradient Header Section -->
  <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-16 text-center shadow-lg">
    <h1 class="text-6xl font-bold mb-4">Reference Checker</h1>
    <p class="text-xl">Upload a PDF to verify citations and analyze references</p>
  </header>
  <div class="container mx-auto px-6 py-10 flex-grow">
    <!-- Combined Info and Upload Section -->
    <section class="mb-12 flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6">
      <!-- Info Section -->
      <div class="md:w-1/2 bg-white rounded-lg shadow-md p-8 flex flex-col justify-between">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Information</h2>
        <div id="infoBox" class="flex-grow"></div>
      </div>
      <!-- Upload Section -->
      <div class="md:w-1/2 bg-white rounded-lg shadow-md p-8 flex flex-col justify-between">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Upload PDF</h2>
        <div class="flex-grow">
          <form id="uploadForm" class="space-y-6">
            <div class="border-2 border-dashed border-gray-400 rounded-lg p-8 text-center transition-colors hover:border-blue-500 hover:bg-blue-50" id="dropZone">
              <input type="file" class="hidden" id="pdfFile" name="file" accept=".pdf" required />
              <div class="space-y-3">
                <i class="fas fa-cloud-upload-alt text-5xl text-gray-500"></i>
                <p class="text-gray-700 text-lg">Drag and drop your PDF here or</p>
                <button type="button" class="px-5 py-3 bg-blue-600 text-white rounded-md shadow-md hover:bg-blue-700 transition-transform focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" onclick="document.getElementById('pdfFile').click()">
                  Browse Files
                </button>
              </div>
            </div>
            <div id="fileInfo" class="hidden">
              <div class="flex items-center space-x-3 text-gray-700">
                <i class="fas fa-file-pdf text-red-500 text-lg"></i>
                <span id="fileName" class="font-medium"></span>
                <button type="button" onclick="clearFile()" class="text-red-500 hover:text-red-700 transition-colors focus:outline-none">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <button type="submit" class="w-full py-3 bg-green-600 text-white rounded-md shadow-md hover:bg-green-700 transition-transform focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
              Process PDF
            </button>
          </form>
        </div>
        <div id="uploadMessage" class="mt-6 hidden"></div>
      </div>
    </section>
    <!-- Processing Queue -->
    <section class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Processing Queue</h2>
        <div class="w-full md:w-1/3">
          <div class="relative">
            <input type="text" id="searchInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search articles..." />
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full table-fixed">
            <thead>
              <tr class="bg-gray-50 text-left">
                <th class="w-3/5 px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Document</th>
                <th class="w-1/5 px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="w-1/5 px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
              </tr>
            </thead>
            <tbody id="queueTableBody" class="bg-white divide-y divide-gray-200">
              <!-- Queue items will be rendered here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- Information & Acknowledgments Section -->
    <section class="bg-gray-200 text-center py-16 mt-10">
      <h2 class="text-3xl font-bold">Information &amp; Acknowledgments</h2>
      <p class="mt-4 text-2xl">Thank you to OpenAI for a grant for API credits for this project!</p>
      <p class="mt-4 text-2xl">by: Emil Cohen, MD</p> 
      <div class="mt-6 flex justify-center space-x-6 items-center">
        <!-- LinkedIn -->
        <a href="https://www.linkedin.com/in/emil-cohen-178199b/" target="_blank" class="text-blue-700 hover:text-blue-900">
          <i class="fab fa-linkedin fa-2x"></i>
        </a>
        <!-- X.com (using Twitter icon as proxy for X) -->
        <a href="https://x.com/ec2904" target="_blank" class="text-gray-800 hover:text-black">
          <i class="fab fa-twitter fa-2x"></i>
        </a>
        <!-- Email -->
        <a href="mailto:cohenemil@gmail.com" class="text-red-600 hover:text-red-800">
          <i class="fas fa-envelope fa-2x"></i>
        </a>
      </div>
    </section>
  </div>
  <!-- Footer -->
  <footer class="bg-gray-200 text-center py-6">
    <p class="text-sm text-gray-600">Â© 2025 Reference Checker. All rights reserved.</p>
  </footer>
  <script type="text/babel">
    const baseURL = "/reference_checker/api";
    // Utility function to show messages
    function showMessage(message, isError = false) {
      const messageDiv = document.getElementById('uploadMessage');
      messageDiv.className = `mt-6 p-4 rounded-md ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} fade-in`;
      messageDiv.textContent = message;
      messageDiv.classList.remove('hidden');
      setTimeout(() => {
        messageDiv.classList.add('hidden');
      }, 5000);
    }
    // File handling functions
    function handleFile(file) {
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      if (file) {
        fileName.textContent = file.name;
        fileInfo.classList.remove('hidden');
      }
    }
    function clearFile() {
      const fileInput = document.getElementById('pdfFile');
      const fileInfo = document.getElementById('fileInfo');
      fileInput.value = '';
      fileInfo.classList.add('hidden');
    }
    // Download handling function
    async function downloadFile(requestId, filename) {
      try {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        const response = await fetch(`${baseURL}/download/${requestId}/${filename}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        button.innerHTML = originalText;
        button.disabled = false;
      } catch (error) {
        console.error('Download failed:', error);
        showMessage(`Failed to download ${filename}: ${error.message}`, true);
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }
    // Modified QueueRow React component with modal for summary on click.
    const QueueRow = ({ requestId, data, onSummaryFetched }) => {
      const [summary, setSummary] = React.useState('');
      const [isLoading, setIsLoading] = React.useState(false);
      const [showModal, setShowModal] = React.useState(false);
      const titleRef = React.useRef(null);
      const fetchSummary = async () => {
        if (!summary && !isLoading) {
          setIsLoading(true);
          try {
            const response = await fetch(`/reference_checker/api/generate_summary`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ request_id: requestId }),
            });
            const result = await response.json();
            setSummary(result.summary);
            onSummaryFetched(requestId, result.summary);
          } catch (error) {
            console.error('Error fetching summary:', error);
          } finally {
            setIsLoading(false);
          }
        }
      };
      const handleClick = () => {
        fetchSummary();
        setShowModal(true);
      };
      return (
        <>
          <tr className="hover:bg-gray-50 border-b border-gray-200 cursor-pointer" onClick={handleClick} ref={titleRef}>
            <td className="px-6 py-4 w-3/5">
              <div className="flex justify-between items-center">
                <div>
                  <div className="text-base font-medium text-gray-900">
                    {data.article_title || data.original_filename}
                  </div>
                  <div className="text-sm text-gray-500">
                    {data.original_filename}
                  </div>
                </div>
                {data.status === 'completed' && (
                  <div className="flex space-x-2">
                    <button onClick={() => downloadFile(requestId, 'confirmations.txt')} className="flex items-center justify-center w-32 h-10 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">
                      <i className="fas fa-file-alt mr-1"></i>
                      <span>Report</span>
                    </button>
                    <button onClick={() => downloadFile(requestId, 'articles.zip')} className="flex items-center justify-center w-32 h-10 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                      <i className="fas fa-file-archive mr-1"></i>
                      <span>Articles</span>
                    </button>
                    <button onClick={() => downloadFile(requestId, 'verified.json')} className="flex items-center justify-center w-32 h-10 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                      <i className="fas fa-download mr-1"></i>
                      <span>JSON</span>
                    </button>
                    <button disabled className="flex items-center justify-center w-48 h-10 bg-gray-300 text-gray-600 rounded cursor-not-allowed text-sm">
                      Upload nonâpublic articles and reârun
                    </button>
                  </div>
                )}
              </div>
            </td>
            <td className="px-6 py-4 w-1/5">
              <div className="flex items-center">
                <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm ${data.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
                  {data.status === 'completed' && <i className="fas fa-check mr-2 text-green-500"></i>}
                  {data.status}
                </span>
              </div>
            </td>
            <td className="px-6 py-4 w-1/5 text-sm text-gray-500">
              {data.progress.stage || 'Completed'}
            </td>
          </tr>
          {showModal &&
            ReactDOM.createPortal(
              <div className="modal-overlay" onClick={() => setShowModal(false)}>
                <div className="modal-content fade-in" onClick={(e) => e.stopPropagation()}>
                  <div className="flex justify-end">
                    <button onClick={() => setShowModal(false)} className="close-button">
                      <i className="fas fa-times"></i>
                    </button>
                  </div>
                  {isLoading ? (
                    <div className="flex items-center space-x-2">
                      <div className="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                      <span className="text-sm text-gray-600">Loading summary...</span>
                    </div>
                  ) : (
                    <div className="text-sm text-gray-700">
                      {summary || 'No summary available'}
                    </div>
                  )}
                </div>
              </div>,
              document.body
            )
          }
        </>
      );
    };
    // Cache for summaries
    let summariesCache = {};
    function cacheSummary(requestId, summary) {
      summariesCache[requestId] = summary;
    }
    // Render all rows into the table body
    async function updateQueueTable() {
      try {
        const response = await fetch(`${baseURL}/status`);
        const data = await response.json();
        const tbody = document.getElementById('queueTableBody');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const newQueueData = data.requests;
        const rows = Object.entries(newQueueData)
          .filter(([requestId, request]) => {
            const summary = summariesCache[requestId] || '';
            const searchableText = [
              request.article_title,
              request.original_filename,
              summary,
              request.status,
              request.progress.stage,
            ]
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            return !searchTerm || searchableText.includes(searchTerm);
          })
          .map(([requestId, request]) => (
            <QueueRow key={requestId} requestId={requestId} data={request} onSummaryFetched={cacheSummary} />
          ));
        ReactDOM.createRoot(tbody).render(<>{rows}</>);
      } catch (error) {
        console.error('Error updating queue:', error);
      }
    }
    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const submitButton = this.querySelector('button[type="submit"]');
      try {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
        const response = await fetch(`${baseURL}/submit`, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();
        if (data.request_id) {
          showMessage(`Upload successful! Request ID: ${data.request_id}`);
          this.reset();
          clearFile();
          await updateQueueTable();
        } else {
          showMessage(data.detail || 'Upload failed', true);
        }
      } catch (error) {
        showMessage(`Upload failed: ${error}`, true);
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = 'Process PDF';
      }
    });
    const dropZone = document.getElementById('dropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
      });
    });
    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      });
    });
    dropZone.addEventListener('drop', (e) => {
      const file = e.dataTransfer.files[0];
      if (file && file.type === 'application/pdf') {
        const fileInput = document.getElementById('pdfFile');
        fileInput.files = e.dataTransfer.files;
        handleFile(file);
      } else {
        showMessage('Please upload a PDF file', true);
      }
    });
    document.getElementById('pdfFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    });
    document.getElementById('searchInput').addEventListener('input', debounce(updateQueueTable, 300));
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    // Replace the info.txt loading with embedded HTML content
    function loadInfoText() {
      const infoHTML = `
        <div class="space-y-4">
          <h2 class="text-2xl font-bold text-gray-800">Reference Checker</h2>
          <p>A program to help academic paper review. The goal of this project is to take some of the hassle out of reviewing academic papers by providing an analysis of the sentences citing sources.</p>
          <p>In my experience with the program, the sentences that are verified with a <strong>âyesâ</strong> or <strong>âmaybeâ</strong> are generally correct. Sentences with a <strong>ânoâ</strong> verdict need further review and can sometimes yield interesting findings.</p>
          <h3 class="text-xl font-semibold text-gray-800">Arbitration Process</h3>
          <p>The arbitration process is made possible with the available API from various models. The challenge was finding a cost-efficient yet effective model with a large enough context window.</p>
          <p>Over the past year, there has been a great deal of progress on this front, both in terms of context window and cost. The program now generally works and produces useful output. It can be even better if you are willing to spend about $1 per article with more expensive models. However, for now, as a proof of concept, the current lower-cost model seems to work.</p>
          <h3 class="text-xl font-semibold text-gray-800">Key Features</h3>
          <div class="ml-6 space-y-2">
            <div>
              <strong>Document Processing:</strong>
              <ul class="list-disc ml-6">
                <li>Processes academic papers in PDF format.</li>
                <li>Extracts the main content and references section.</li>
              </ul>
            </div>
            <div>
              <strong>Reference Analysis:</strong>
              <ul class="list-disc ml-6">
                <li>Identifies citations within the paper.</li>
                <li>Organizes and maps references to their corresponding citations.</li>
              </ul>
            </div>
            <div>
              <strong>Document Retrieval:</strong>
              <ul class="list-disc ml-6">
                <li>Automatically downloads full-text PDFs of cited papers whenever available through open sources.</li>
                <li>Can be modified to work with paywalled systems in future versions for a more complete analysis.</li>
              </ul>
            </div>
            <div>
              <strong>Citation Verification:</strong>
              <ul class="list-disc ml-6">
                <li>Employs AI to analyze both the citing text and cited paper.</li>
                <li>Delivers verdicts (<strong>yes</strong>/<strong>no</strong>/<strong>maybe</strong>) with explanations for each citation.</li>
              </ul>
            </div>
            <div>
              <strong>Output Generation:</strong>
              <ul class="list-disc ml-6">
                <li>Provides detailed results in JSON format.</li>
                <li>Generates a readable text summary of all verifications.</li>
                <li>Contains links to cited papers for easier access to the sources for further verification as needed.</li>
                <li>Includes a zip file with all downloaded reference papers for easier access for the reviewer.</li>
              </ul>
            </div>
          </div>
          <h3 class="text-xl font-semibold text-gray-800">Benefits</h3>
          <div class="ml-6 space-y-2">
            <div>
              <strong>Efficiency:</strong>
              <ul class="list-disc ml-6">
                <li>Automates the citation-checking process, saving time and effort.</li>
                <li>Verifies the accuracy of citations, ensuring research integrity.</li>
              </ul>
            </div>
            <div>
              <strong>Accessibility:</strong>
              <ul class="list-disc ml-6">
                <li>Makes referenced papers easily accessible, facilitating deeper understanding.</li>
              </ul>
            </div>
            <div>
              <strong>Transparency:</strong>
              <ul class="list-disc ml-6">
                <li>Provides clear documentation of citation validity, enhancing transparency.</li>
              </ul>
            </div>
            <div>
              <strong>Scalability:</strong>
              <ul class="list-disc ml-6">
                <li>Handles multiple documents simultaneously, supporting large-scale research projects.</li>
              </ul>
            </div>
          </div>
          <p>Obviously, it would be feasible to have this model work with non-public articles to get a complete analysis, but I have chosen to disable that for the demo.</p>
          <p>Ideally, this program should be deployed by publishers and used to enhance the review process and increase factuality and efficiency.</p>
          <p>It would also be interesting to see how many 'mistakes' there are in different fields and publications ;-)</p>
          <p class="mt-4 font-semibold">Let me know what you think: Emil Cohen</p>
        </div>
      `;
      document.getElementById('infoBox').innerHTML = infoHTML;
    }
    loadInfoText();
    updateQueueTable();
    setInterval(updateQueueTable, 10000);
  </script>
</body>
</html>

